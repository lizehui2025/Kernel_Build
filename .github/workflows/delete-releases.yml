name: Batch Delete Releases

on:
  workflow_dispatch: # 支持手动从 Action 页面触发
    inputs:
      keep_latest:
        description: '保留最近的 Release 数量 (0 表示全部删除)'
        required: true
        default: '0'

jobs:
  delete-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须赋予写入权限才能删除 Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Batch Delete Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 使用 JSON 格式精准获取所有的 tagName
          # 这可以避免 awk 截取字符串不准的问题
          TAGS=$(gh release list --limit 1000 --json tagName --jq '.[].tagName')

          KEEP_COUNT=${{ github.event.inputs.keep_latest || 0 }}

          # 2. 将标签列表存入数组
          # 使用 mapfile 或 readarray 可以安全处理特殊字符
          readarray -t TAG_ARRAY <<< "$TAGS"

          COUNT=${#TAG_ARRAY[@]}
          echo "检测到 Release 总数: $COUNT"

          if [ "$COUNT" -le "$KEEP_COUNT" ]; then
            echo "当前数量未达到保留阈值，跳过删除。"
            exit 0
          fi

          # 3. 计算需要删除的部分（排除前 N 个最新的）
          # 使用 "${TAG_ARRAY[@]:$KEEP_COUNT}" 语法进行切片
          TO_DELETE=("${TAG_ARRAY[@]:$KEEP_COUNT}")

          echo "准备删除以下 Release:"
          for tag in "${TO_DELETE[@]}"; do
            # 如果 tag 为空则跳过（防止 readarray 产生的空行）
            [[ -z "$tag" ]] && continue
            
            echo "正在删除 Release: \"$tag\""
            
            # 使用双引号包裹 "$tag"，并添加 || true 确保单个失败不卡死整个流程
            # --cleanup-tag 会连同 git tag 一起删掉，按需决定是否保留
            gh release delete "$tag" --yes --cleanup-tag || echo "无法删除 $tag，可能已被删除或权限不足"
          done
