name: BazelÊûÑÂª∫ 6.6.89 Ê¨ßÂä†ÁúüOKIÂÜÖÊ†∏
env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  BAZEL_CACHE_DIR: ${{ github.workspace }}/.bazel_cache
on:
  workflow_dispatch:
    inputs:
      DEVICES_NAME:
        description: "ËØ∑ÈÄâÊã©Ë¶ÅÁºñËØëÁöÑÊú∫ÂûãÔºö"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_ace_6'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
          - 'realme_GT8'
        default: 'oneplus_13'
      keep_original_settings:
        description: "‰øùÊåÅÂéüÂÜÖÊ†∏ÂêçÁß∞ÂèäÊûÑÂª∫Êó∂Èó¥(‰∏çÊáÇËØ∑‰øùÊåÅÈªòËÆ§)"
        required: false
        default: true
        type: boolean
      custom_kernel_suffix:
        description: " Ëá™ÂÆö‰πâÂÜÖÊ†∏ÂêçÁß∞"
        required: false
        default: ''
      custom_kernel_time:
        description: " Ëá™ÂÆö‰πâÊûÑÂª∫Êó∂Èó¥"
        required: false
        default: ''
      ksu_type:
        description: 'KernelSUÂàÜÊîØ'
        required: true
        type: choice
        default: 'none'
        options:
          - 'sukisu'
          - 'resukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
          - 'none'
      susfs_enable:
        description: 'ÊòØÂê¶ÂºÄÂêØsusfs(ËØ•ÈÄâÈ°π‰∏éHymoFSÂÜ≤Á™Å)'
        required: true
        type: boolean
        default: 'false'
      kpm_enable:
        description: 'ÊòØÂê¶ÂºÄÂêØkpm'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'builtin'
          - 'kpn'
      lz4_enable:
        description: 'ÊòØÂê¶ÂÆâË£Ö lz4 1.10.0+zstd 1.5.7 Ë°•‰∏ÅÂèä LZ4KD Ë°•‰∏Å'
        required: true
        type: boolean
        default: 'true'
      lz4kd_enable:
        description: 'ÊòØÂê¶ÂÆâË£Ö LZ4KD Ë°•‰∏Å'
        required: true
        type: boolean
        default: 'false'
      bbr_enable:
        description: "ÊòØÂê¶ÂêØÁî®bbrÁÆóÊ≥ï"
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: 'ÊòØÂê¶ÂºÄÂêØÁΩëÁªúÂäüËÉΩÊãìÂ±ïÈÖçÁΩÆ'
        required: true
        type: boolean
        default: 'true'
      adios_enable:
        description: 'ÊòØÂê¶ÂêØÁî®ADIOS IOË∞ÉÂ∫¶Âô®ÊîØÊåÅ'
        required: true
        type: boolean
        default: 'true'
      rekernel_enable:
        description: 'ÊòØÂê¶ÂêØÁî®Re-KernelÊîØÊåÅ'
        required: true
        type: boolean
        default: 'false'
      baseband_guard:
        description: 'ÊòØÂê¶ÂºÄÂêØÂÜÖÊ†∏Á∫ßÂü∫Â∏¶‰øùÊä§'
        required: true
        type: boolean
        default: 'true'
      enable_hymo:
        description: "Ê∑ªÂä†HymoÂÆûÁé∞(È´òÊÄßËÉΩÊ∑∑ÂêàÊåÇËΩΩÂÖÉÊ®°ÂùóÔºåËØ•ÈÄâÈ°π‰∏éSuSFSÂÜ≤Á™Å)"
        required: true
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEVICES_NAME:           ${{ github.event.inputs.DEVICES_NAME }}
      KEEP_ORIGINAL_SETTINGS: ${{ github.event.inputs.keep_original_settings }}
      CUSTOM_KERNEL_SUFFIX:   ${{ github.event.inputs.custom_kernel_suffix }}
      CUSTOM_KERNEL_TIME:     ${{ github.event.inputs.custom_kernel_time }}
      ENABLE_HYMO:            ${{ github.event.inputs.enable_hymo }}
    outputs:
      ksuver: ${{ steps.ksu_version.outputs.ksuver }}
    steps:
      - name: Ê£ÄÊü•ËæìÂÖ•ÈÖçÁΩÆÂÜ≤Á™Å
        shell: bash
        run: |
          SUSFS="${{ github.event.inputs.susfs_enable }}"
          HYMO="${{ github.event.inputs.enable_hymo }}"
          if [[ "$SUSFS" == "true" && "$HYMO" == "true" ]]; then
            echo "::error::ÈÖçÁΩÆÈîôËØØÔºö‰∏çËÉΩÂêåÊó∂ÂêØÁî® SUSFS Âíå HYMOFSÔºÅ"
            exit 1
          fi

      - name: ÈÖçÁΩÆ Swap Á©∫Èó¥
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 24

      - name: ËÆæÁΩÆ REPO_MANIFEST ‰∏éÊú∫ÂûãÈÖçÁΩÆ
        run: |
          case "${{ env.DEVICES_NAME }}" in
            oneplus_ace5_pro) echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_ace5_pro" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_ace5_pro_b" >> $GITHUB_ENV ;;
            oneplus_13) echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_13" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV ;;
            oneplus_ace_6) echo "REPO_MANIFEST=sm8750_b_16.0.0_ace_6" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_ace_6" >> $GITHUB_ENV ;;
            oneplus_13t) echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_13t" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_13t_b" >> $GITHUB_ENV ;;
            oneplus_pad_2_pro) echo "REPO_MANIFEST=sm8750_b_16.0.0_pad_2_pro" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_pad_2_pro_b" >> $GITHUB_ENV ;;
            oneplus_ace5_ultra | realme_GT7) echo "REPO_MANIFEST=mt6991_v_15.0.2_ace5_ultra" >> $GITHUB_ENV; echo "SCHED_FILE=oneplus_ace5_ultra" >> $GITHUB_ENV ;;
            realme_GT7pro | realme_GT7pro_Speed | realme_GT8) echo "SCHED_FILE=none" >> $GITHUB_ENV ;;
          esac
          
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "true" ] && [ -z "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            case "${{ env.DEVICES_NAME }}" in
              oneplus_pad_2_pro) echo 'DEFAULT_SUFFIX=-android15-8-g5a0ffb447c1d-ab13771415-4k' >> $GITHUB_ENV ;;
              oneplus_13) echo 'DEFAULT_SUFFIX=-android15-8-gf4dc45704e54-abogki446052083-4k' >> $GITHUB_ENV ;;
              realme_GT7) echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV ;;
              *) echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV ;;
            esac
          else
            echo "DEFAULT_SUFFIX=${{ github.event.inputs.custom_kernel_suffix }}" >> $GITHUB_ENV
          fi
          
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "true" ] && [ -z "${{ github.event.inputs.custom_kernel_time }}" ]; then
            case "${{ env.DEVICES_NAME }}" in
              oneplus_pad_2_pro) echo 'KERNEL_TIME=Fri Jul 11 22:46:09 UTC 2025' >> $GITHUB_ENV ;;
              oneplus_13) echo 'KERNEL_TIME=Fri Sep 19 06:13:40 UTC 2025' >> $GITHUB_ENV ;;
              realme_GT7) echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV ;;
              *) echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV ;;
            esac
          else
            echo "KERNEL_TIME=${{ github.event.inputs.custom_kernel_time }}" >> $GITHUB_ENV
          fi

      - name: Ê∏ÖÁêÜÁéØÂ¢ÉÂπ∂ÂàùÂßãÂåñÂÜÖÊ†∏Ê∫êÁ†Å‰ªìÂ∫ì
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL &
          sudo apt update && sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev &
          
          mkdir kernel_workspace && cd kernel_workspace
          echo "Ê≠£Âú®ÂÖãÈöÜÊ∫êÁ†Å‰ªìÂ∫ì..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89.zip -o common.zip && 
          unzip -q common.zip && 
          mv "android_kernel_common_oneplus_sm8750-oneplus-sm8750_v_16.0.0_oneplus_13_6.6.89" common &&
          rm -rf common.zip
          wait
          
          echo "Ê≠£Âú®ÂéªÈô§ ABI ‰øùÊä§ & ÂéªÈô§ dirty ÂêéÁºÄ..."
          rm common/android/abi_gki_protected_exports_* || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done

      - name: ËΩΩÂÖ• Bazel ÁºìÂ≠ò
        uses: actions/cache@v4
        with:
          path: ${{ env.BAZEL_CACHE_DIR }}
          key: bazel-kernel-${{ github.event.inputs.DEVICES_NAME }}-${{ github.sha }}
          restore-keys: |
            bazel-kernel-${{ github.event.inputs.DEVICES_NAME }}-

      - name: Ê∑ªÂä† KernelSU Ê∫êÁ†Å
        id: ksu_version
        run: |
          cd kernel_workspace
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" ]]; then
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/refs/heads/main/kernel/setup.sh" | bash -s builtin
            cd KernelSU
            GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
            KSU_API_VERSION=$(curl -s "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/builtin/kernel/Kbuild" | grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
            [ -z "$KSU_API_VERSION" ] && KSU_API_VERSION="3.1.7"
            VERSION_DEFINITIONS=$'define get_ksu_version_full\nv\\$1-'"$GIT_COMMIT_HASH"$'@cctv18\nendef\n\nKSU_VERSION_API := '"$KSU_API_VERSION"$'\nKSU_VERSION_FULL := v'"$KSU_API_VERSION"$'-'"$GIT_COMMIT_HASH"$'@cctv18'
            sed -i '/define get_ksu_version_full/,/endef/d' kernel/Kbuild
            sed -i '/KSU_VERSION_API :=/d' kernel/Kbuild
            sed -i '/KSU_VERSION_FULL :=/d' kernel/Kbuild
            awk -v def="$VERSION_DEFINITIONS" '/REPO_OWNER :=/ {print; print def; inserted=1; next} 1 END {if (!inserted) print def}' kernel/Kbuild > kernel/Kbuild.tmp && mv kernel/Kbuild.tmp kernel/Kbuild
            KSU_VERSION=$(expr $(git rev-list --count main) + 37185 2>/dev/null || echo 114514)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]]; then
            curl -LSs "https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/refs/heads/main/kernel/setup.sh" | bash -s main
            echo 'CONFIG_KSU_FULL_NAME_FORMAT="%TAG_NAME%-%COMMIT_SHA%@cctv18"' >> ./common/arch/arm64/configs/gki_defconfig
            cd KernelSU
            KSU_VERSION=$(expr $(git rev-list --count main) + 30700 2>/dev/null || echo 114514)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
          elif [[ ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/dev-susfs/kernel/setup.sh" | bash -s dev-susfs
            cd KernelSU-Next
            rm -rf .git
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/pershoot/KernelSU-Next/commits?sha=dev&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            sed -i "s/KSU_VERSION_FALLBACK := 1/KSU_VERSION_FALLBACK := $KSU_VERSION/g" kernel/Kbuild
            cd ../common/drivers/kernelsu
            wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/apk_sign.patch
            patch -p2 -N -F 3 < apk_sign.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" || ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            REPO=$([[ ${{ github.event.inputs.ksu_type }} == "mksu" ]] && echo "5ec1cff" || echo "tiann")
            curl -LSs "https://raw.githubusercontent.com/${REPO}/KernelSU/refs/heads/main/kernel/setup.sh" | bash -s main
            cd KernelSU
            KSU_VERSION=$(expr $(curl -sI "https://api.github.com/repos/${REPO}/KernelSU/commits?sha=main&per_page=1" | grep -i "link:" | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p') "+" 30000)
            echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
            echo "ksuver=$KSU_VERSION" >> $GITHUB_OUTPUT
            sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Kbuild
          fi

      - name: Â∫îÁî® SUSFS Ë°•‰∏Å
        if: inputs.susfs_enable
        run: |
          cd kernel_workspace
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/69_hide_stuff.patch -O ./common/69_hide_stuff.patch
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./common/
          cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          
          if [[ ${{ github.event.inputs.ksu_type }} == "sukisu" || ${{ github.event.inputs.ksu_type }} == "resukisu" || ${{ github.event.inputs.ksu_type }} == "ksunext" ]]; then
            cd common
            [[ ${{ github.event.inputs.ksu_type }} == "resukisu" ]] && sed -i 's|vma = find_vma(mm|struct vm_area_struct *\&|' ./fs/proc/task_mmu.c
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
            patch -p1 -N -F 3 < 69_hide_stuff.patch || true
          elif [[ ${{ github.event.inputs.ksu_type }} == "mksu" || ${{ github.event.inputs.ksu_type }} == "ksu" ]]; then
            cp ./susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./KernelSU/
            sed -i 's|kernel/Makefile|kernel/Kbuild|g; s|^@@ .* format:.*|@@ -94,4 +94,13 @@|; s|.*check-format:.*| ccflags-y += -Wno-strict-prototypes -Wno-int-conversion -Wno-gcc-compat -Wno-missing-prototypes|; s|.*clang-format --dry-run.*| ccflags-y += -Wno-declaration-after-statement -Wno-unused-function -Wno-unused-variable|' ./KernelSU/10_enable_susfs_for_ksu.patch
            cd KernelSU
            patch -p1 < 10_enable_susfs_for_ksu.patch || true
            [[ ${{ github.event.inputs.ksu_type }} == "mksu" ]] && wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/mksu_supercalls.patch && patch -p1 < mksu_supercalls.patch || true
            cd ../common
            patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
            patch -p1 -N -F 3 < 69_hide_stuff.patch || true
          fi

      - name: Â∫îÁî® lz4 & zstd & lz4kd Ë°•‰∏Å
        run: |
          cd kernel_workspace
          if [[ "${{ github.event.inputs.lz4_enable }}" == "true" ]]; then
            git clone --depth=1 https://github.com/cctv18/oppo_oplus_realme_sm8750.git
            cp ./oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch ./common/
            cp ./oppo_oplus_realme_sm8750/zram_patch/lz4armv8.S ./common/lib
            cp ./oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch ./common/
            cd common
            git apply -p1 < 001-lz4.patch || true
            patch -p1 < 002-zstd.patch || true
            cd ..
          fi
          if [[ "${{ github.event.inputs.lz4kd_enable }}" == "true" ]]; then
            git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git
            cd common
            cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./include/linux/
            cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./lib
            cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./crypto
            cp ../SukiSU_patch/other/zram/zram_patch/${{ env.KERNEL_VERSION }}/lz4kd.patch ./
            patch -p1 -F 3 < lz4kd.patch || true
          fi

      - name: Â∫îÁî® HymoFS Ë°•‰∏Å
        if: inputs.enable_hymo
        run: |
          cd kernel_workspace/common
          wget https://raw.githubusercontent.com/Anatdx/HymoFS/refs/heads/android15_6.6/patch/hymofs.patch
          patch -p1 -F 3 < hymofs.patch
          echo "CONFIG_HYMOFS=y" >> ./arch/arm64/configs/gki_defconfig

      - name: Ê∑ªÂä† Defconfig ÈÖçÁΩÆÈ°π (KSU/SUSFS/ÁΩëÁªú/BBRÁ≠â)
        run: |
          cd kernel_workspace/common
          CONFIG_FILE="./arch/arm64/configs/gki_defconfig"
          
          echo "CONFIG_KSU=y" >> $CONFIG_FILE
          [[ ${{ github.event.inputs.kpm_enable }} == 'builtin' && ( "${{ github.event.inputs.ksu_type }}" == "sukisu" || "${{ github.event.inputs.ksu_type }}" == "resukisu" ) ]] && echo "CONFIG_KPM=y" >> $CONFIG_FILE
          
          if [[ "${{ github.event.inputs.susfs_enable }}" == "true" ]]; then
            cat <<EOF >> $CONFIG_FILE
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          EOF
          else
            echo "CONFIG_KSU_SUSFS=n" >> $CONFIG_FILE
          fi
          
          echo "CONFIG_TMPFS_XATTR=y" >> $CONFIG_FILE
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONFIG_FILE
          echo "CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y" >> $CONFIG_FILE
          echo "CONFIG_LTO_CLANG_THIN=y" >> $CONFIG_FILE
          echo "CONFIG_HEADERS_INSTALL=n" >> $CONFIG_FILE
          
          if [[ "${{ github.event.inputs.lz4kd_enable }}" == "true" ]]; then
            cat <<EOF >> $CONFIG_FILE
          CONFIG_ZSMALLOC=y
          CONFIG_CRYPTO_LZ4HC=y
          CONFIG_CRYPTO_LZ4K=y
          CONFIG_CRYPTO_LZ4KD=y
          CONFIG_CRYPTO_842=y
          EOF
          fi
          
          if [[ "${{ github.event.inputs.better_net }}" == "true" ]]; then
            cat <<EOF >> $CONFIG_FILE
          CONFIG_BPF_STREAM_PARSER=y
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y
          CONFIG_NETFILTER_XT_SET=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y
          CONFIG_IP6_NF_NAT=y
          CONFIG_IP6_NF_TARGET_MASQUERADE=y
          EOF
            wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/other_patch/config.patch
            patch -p1 -F 3 < config.patch || true
          fi
          
          if [[ "${{ github.event.inputs.bbr_enable }}" != "false" ]]; then
            cat <<EOF >> $CONFIG_FILE
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_TCP_CONG_CUBIC=y
          CONFIG_TCP_CONG_VEGAS=y
          CONFIG_TCP_CONG_NV=y
          CONFIG_TCP_CONG_WESTWOOD=y
          CONFIG_TCP_CONG_HTCP=y
          CONFIG_TCP_CONG_BRUTAL=y
          EOF
            [[ "${{ github.event.inputs.bbr_enable }}" == "default" ]] && echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> $CONFIG_FILE || echo "CONFIG_DEFAULT_TCP_CONG=cubic" >> $CONFIG_FILE
          fi
          
          [[ "${{ github.event.inputs.adios_enable }}" == "true" ]] && echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> $CONFIG_FILE && echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> $CONFIG_FILE
          [[ "${{ github.event.inputs.rekernel_enable }}" == "true" ]] && echo "CONFIG_REKERNEL=y" >> $CONFIG_FILE
          
          if [[ "${{ github.event.inputs.baseband_guard }}" == "true" ]]; then
            echo "CONFIG_BBG=y" >> $CONFIG_FILE
            curl -sSL https://github.com/cctv18/Baseband-guard/raw/master/setup.sh | bash
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig
          fi
          
          ESCAPED_SUFFIX=$(printf '%s\n' "$DEFAULT_SUFFIX" | sed 's:[\/&]:\\&:g')
          sed -i "s/-4k/$ESCAPED_SUFFIX/g" $CONFIG_FILE
          sed -i 's/${scm_version}//' ./scripts/setlocalversion
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Âü∫‰∫é Bazel ÊâßË°åÂ∫ïÂ±ÇÁºñËØë
        run: |
          cd kernel_workspace/common
          
          # Kleaf ÈÄöËøáÁéØÂ¢ÉÂèòÈáèÁõ¥Êé•ÊéßÂà∂ÊûÑÂª∫Êó∂Èó¥Êà≥ÔºåÊó†ÈúÄÁπÅÁêêÁöÑ LD_PRELOAD
          export KBUILD_BUILD_TIMESTAMP="${KERNEL_TIME}"
          
          # Âä®ÊÄÅÊü•ÊâæÂÜÖÊ†∏ÊûÑÂª∫ÁõÆÊ†áÔºàÈÄöÂ∏∏ Kleaf GKI ‰Ωç‰∫é //common:kernel_aarch64ÔºåÂèØÊ†πÊçÆÂÖ∑‰Ωì OEM Ë∞ÉÊï¥Ôºâ
          BAZEL_TARGET="//common:kernel_aarch64"
          
          # ‰º†ÈÄí‰∏ìÈó®ÈíàÂØπÈ™ÅÈæôÂ∫ïÂ±ÇÂπ≥Âè∞ÁöÑ MLGO Âíå LTO ÂèÇÊï∞
          CUSTOM_CFLAGS="-O2 -mllvm -enable-ml-inliner=release -mllvm -regalloc-enable-advisor=release"
          
          echo "ÂºÄÂßãÊâßË°å Bazel (Kleaf) ÊûÑÂª∫Ôºå‰ΩøÁî®Ê≤ôÁõíÈöîÁ¶ªÁéØÂ¢É..."
          tools/bazel build $BAZEL_TARGET \
            --config=fast \
            --lto=thin \
            --disk_cache="${{ env.BAZEL_CACHE_DIR }}" \
            --action_env=KBUILD_BUILD_TIMESTAMP \
            --//common:custom_cflags="$CUSTOM_CFLAGS"
            
          echo "Bazel ÊûÑÂª∫ÂÆåÊàêÔºÅ"

      - name: ÊèêÂèñÁºñËØë‰∫ßÁâ©Âπ∂Â∫îÁî® KPM
        run: |
          cd kernel_workspace/common
          
          # Bazel ÁöÑËæìÂá∫ÈÄöÂ∏∏‰Ωç‰∫é bazel-bin ÁõÆÂΩï‰∏ãÔºåÊàë‰ª¨ÈúÄË¶ÅÂä®ÊÄÅÊü•ÊâæÁîüÊàêÁöÑ Image
          IMAGE_PATH=$(find bazel-bin/ -name "Image" -type f | head -n 1)
          
          if [[ -z "$IMAGE_PATH" ]]; then
            echo "::error::Bazel ÁºñËØë‰∫ßÁâ© Image Êú™ÊâæÂà∞ÔºÅ"
            exit 1
          fi
          
          mkdir -p out_boot
          cp "$IMAGE_PATH" out_boot/Image
          
          if [[ ${{ github.event.inputs.kpm_enable }} == 'builtin' && ( "${{ github.event.inputs.ksu_type }}" == "sukisu" || "${{ github.event.inputs.ksu_type }}" == "resukisu" ) ]]; then
            cd out_boot
            curl -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/latest/download/patch_linux
            chmod +x patch_linux
            ./patch_linux
            rm -f Image && mv oImage Image
          fi

      - name: AnyKernel3 ÊâìÂåÖ
        run: |
          cd kernel_workspace
          git clone https://github.com/cctv18/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          cd AnyKernel3
          
          cp ../common/out_boot/Image ./Image
          
          case "${{ github.event.inputs.ksu_type }}" in
            sukisu) KSU_TYPENAME="SukiSU" ;;
            resukisu) KSU_TYPENAME="ReSukiSU" ;;
            ksunext) KSU_TYPENAME="KSUNext" ;;
            mksu) KSU_TYPENAME="MKSU" ;;
            ksu) KSU_TYPENAME="KSU" ;;
            *) KSU_TYPENAME="none" ;;
          esac
          
          [[ "${{ github.event.inputs.lz4kd_enable }}" == "true" ]] && wget https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/refs/heads/main/zram.zip
          [[ ${{ github.event.inputs.kpm_enable }} == 'kpn' ]] && wget https://github.com/cctv18/KPatch-Next/releases/latest/download/kpn.zip
          
          if [[ -n "${{ github.event.inputs.custom_kernel_suffix }}" ]]; then
            zip -r ../AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_${{ github.event.inputs.custom_kernel_suffix }}.zip ./*
          else
            zip -r ../AnyKernel3_${KSU_TYPENAME}_${{ env.KSUVER }}_${{ env.KERNEL_VERSION }}_A15_Default.zip ./*
          fi

      - name: ‰∏ä‰º† ZIP Â∑•‰ª∂
        uses: actions/upload-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ${{ github.workspace }}/kernel_workspace/AnyKernel*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ‰∏ãËΩΩ ZIP Â∑•‰ª∂
        uses: actions/download-artifact@v4
        with:
          name: Kernel_ZIP_Artifacts
          path: ./release_zips

      - name: ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè‰∏éÂèëÂ∏É
        run: |
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          TAG_HEAD="OPPO+OPlus+Realme-A15-Bazel-build"
          
          case "${{ github.event.inputs.ksu_type }}" in
            sukisu) KSU_TYPENAME="SukiSU Ultra" ;;
            resukisu) KSU_TYPENAME="ReSukiSU" ;;
            ksunext) KSU_TYPENAME="KernelSU Next" ;;
            mksu) KSU_TYPENAME="MKSU" ;;
            ksu) KSU_TYPENAME="KSU" ;;
            *) KSU_TYPENAME="Êó†ÂÜÖÁΩÆKSU" ;;
          esac
          
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          echo "KSU_TYPENAME=$KSU_TYPENAME" >> $GITHUB_ENV

      - name: ÂàõÂª∫ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }} (Bazel) - 6.6.89"
          body: |
            ### üì± Ê¨ßÂä†Áúü ${{ env.KSU_TYPENAME }} SM8750 ÈÄöÁî®ÂÜÖÊ†∏ | Bazel Ê≤ôÁõíÊûÑÂª∫Áâà
            - ÁºñËØëÂºïÊìé: Bazel / Kleaf
            - ÁºñËØëÊó∂Èó¥: ${{ env.TIME_FORM }}
            - ÁâπÊÄßÔºö${{ env.KSU_TYPENAME }} + È´òÁ∫ß‰ºòÂåñÂèÇÊï∞
            - susfsÊîØÊåÅÔºö${{ github.event.inputs.susfs_enable }}
            - KPMÊîØÊåÅ Ôºö${{ github.event.inputs.kpm_enable }}
            - LZ4/LZ4KDÊîØÊåÅÔºö${{ github.event.inputs.lz4_enable }} / ${{ github.event.inputs.lz4kd_enable }}
          draft: false
          prerelease: false
          files: |
            release_zips/AnyKernel3_*.zip
